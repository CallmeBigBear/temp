#!/bin/bash

# ========== C·∫§U H√åNH ==========
NULLA_PATH="/home/nulla"  # ƒê∆∞·ªùng d·∫´n ch·ª©a c√°c file th·ª±c thi
WALLET_NAME="wallet"
WALLET_DEST="bob"  # Wallet ƒë√≠ch ƒë·ªÉ nh·∫≠n token
FAUCET_INTERVAL=10  # Th·ªùi gian gi·ªØa c√°c l·∫ßn faucet (gi√¢y)
TRANSFER_AMOUNT=100  # S·ªë l∆∞·ª£ng token g·ª≠i
TRANSFER_INTERVAL_MIN=20  # Th·ªùi gian t·ªëi thi·ªÉu gi·ªØa c√°c l·∫ßn transfer (gi√¢y)
TRANSFER_INTERVAL_MAX=60  # Th·ªùi gian t·ªëi ƒëa gi·ªØa c√°c l·∫ßn transfer (gi√¢y)
WS="ws://127.0.0.1:9944"

# Chuy·ªÉn v√†o th∆∞ m·ª•c nulla ƒë·ªÉ wallet ƒë∆∞·ª£c t√¨m th·∫•y
cd $NULLA_PATH

# M√†u s·∫Øc cho log
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# ========== SCRIPT ==========
export WS=$WS

# H√†m cleanup khi script k·∫øt th√∫c
cleanup() {
    echo ""
    echo "[$(date '+%H:%M:%S')] ƒêang d·ª´ng faucet server..."
    if [ ! -z "$FAUCET_PID" ]; then
        kill $FAUCET_PID 2>/dev/null
        wait $FAUCET_PID 2>/dev/null
    fi
    echo "[$(date '+%H:%M:%S')] ƒê√£ d·ª´ng. T·∫°m bi·ªát!"
    exit 0
}

# H√†m check balance
check_balance() {
    local wallet_name=$1
    echo -e "${YELLOW}[$(date '+%H:%M:%S')] üîç SCANNING $wallet_name...${NC}"
    ./nulla-wallet scan --name $wallet_name
    local balance=$(./nulla-wallet balance --name $wallet_name | awk '/Total Balance:/ {print $(NF-1)}')
    echo -e "${GREEN}[BALANCE] $wallet_name: $balance${NC}"
}

# B·∫Øt t√≠n hi·ªáu Ctrl+C v√† t√≠n hi·ªáu k·∫øt th√∫c
trap cleanup SIGINT SIGTERM

echo "===== B·∫ÆT ƒê·∫¶U AUTO FAUCET ====="
echo "Wallet ngu·ªìn: $WALLET_NAME"
echo "Wallet ƒë√≠ch: $WALLET_DEST"
echo "Faucet interval: ${FAUCET_INTERVAL}s"
echo "Transfer amount: $TRANSFER_AMOUNT"
echo "Transfer interval: ${TRANSFER_INTERVAL_MIN}s - ${TRANSFER_INTERVAL_MAX}s (random)"
echo "WS: $WS"
echo "================================"

# Kh·ªüi ƒë·ªông faucet server ·ªü background
echo "[$(date '+%H:%M:%S')] Kh·ªüi ƒë·ªông faucet server..."
./nulla-faucet &
FAUCET_PID=$!

# ƒê·ª£i server kh·ªüi ƒë·ªông
echo "[$(date '+%H:%M:%S')] ƒê·ª£i server kh·ªüi ƒë·ªông (5s)..."
sleep 5

echo "[$(date '+%H:%M:%S')] Ki·ªÉm tra wallet '$WALLET_NAME'..."
./nulla-wallet address --name $WALLET_NAME

# ƒê·∫øm s·ªë l·∫ßn faucet v√† transfer
faucet_count=0
transfer_count=0
last_transfer=0
next_transfer_interval=$((TRANSFER_INTERVAL_MIN + RANDOM % (TRANSFER_INTERVAL_MAX - TRANSFER_INTERVAL_MIN + 1)))

while true; do
    # Faucet token
    echo -e "\n================================\n"
    echo -e "${CYAN}[$(date '+%H:%M:%S')] üíß FAUCET l·∫ßn th·ª© $((faucet_count + 1))...${NC}"
    $NULLA_PATH/nulla-wallet faucet --name $WALLET_NAME
    echo -e "\n================================\n"
    
    faucet_count=$((faucet_count + 1))
    
    # Ki·ªÉm tra xem ƒë√£ ƒë·∫øn l√∫c transfer ch∆∞a
    if [ $((faucet_count * FAUCET_INTERVAL)) -ge $((last_transfer + next_transfer_interval)) ]; then
        echo -e "${BLUE}[$(date '+%H:%M:%S')] ‚è∞ ƒê√£ ƒë·∫øn l√∫c transfer (sau ${next_transfer_interval}s)${NC}"
        echo -e "\n================================\n"
        # Scan wallet ngu·ªìn tr∆∞·ªõc khi transfer
        echo -e "${YELLOW}[$(date '+%H:%M:%S')] üîç SCANNING $WALLET_NAME tr∆∞·ªõc khi transfer...${NC}"
        $NULLA_PATH/nulla-wallet scan --name $WALLET_NAME
        echo -e "\n================================\n"
        
        # L·∫•y address c·ªßa wallet ƒë√≠ch (bob)
        echo -e "${BLUE}[$(date '+%H:%M:%S')] üìç L·∫•y address c·ªßa wallet $WALLET_DEST...${NC}"
        ADDRESS=$($NULLA_PATH/nulla-wallet address --name $WALLET_DEST | awk '/Stealth Address:/ {print $NF}')
        echo -e "\n================================\n"
        
        # Transfer token t·ª´ wallet ngu·ªìn sang wallet ƒë√≠ch
        echo -e "${MAGENTA}[$(date '+%H:%M:%S')] üí∏ TRANSFER l·∫ßn th·ª© $((transfer_count + 1)) t·ª´ $WALLET_NAME -> $WALLET_DEST - Amount: $TRANSFER_AMOUNT...${NC}"
        $NULLA_PATH/nulla-wallet transfer --name $WALLET_NAME --to "$ADDRESS" --amount $TRANSFER_AMOUNT
        echo -e "\n================================\n"
        
        # Scan wallet ƒë√≠ch tr∆∞·ªõc khi transfer ng∆∞·ª£c
        echo -e "${YELLOW}[$(date '+%H:%M:%S')] üîç SCANNING $WALLET_DEST tr∆∞·ªõc khi transfer ng∆∞·ª£c...${NC}"
        $NULLA_PATH/nulla-wallet scan --name $WALLET_DEST
        echo -e "\n================================\n"
        
        # Transfer ng∆∞·ª£c l·∫°i 1 n·ª≠a t·ª´ wallet ƒë√≠ch v·ªÅ wallet ngu·ªìn
        RETURN_AMOUNT=$((TRANSFER_AMOUNT / 2))
        echo -e "${BLUE}[$(date '+%H:%M:%S')] üìç L·∫•y address c·ªßa wallet $WALLET_NAME...${NC}"
        ADDRESS_RETURN=$($NULLA_PATH/nulla-wallet address --name $WALLET_NAME | awk '/Stealth Address:/ {print $NF}')
        echo -e "\n================================\n"
        
        echo -e "${MAGENTA}[$(date '+%H:%M:%S')] üí∏ TRANSFER NG∆Ø·ª¢C t·ª´ $WALLET_DEST -> $WALLET_NAME - Amount: $RETURN_AMOUNT...${NC}"
        $NULLA_PATH/nulla-wallet transfer --name $WALLET_DEST --to "$ADDRESS_RETURN" --amount $RETURN_AMOUNT
        echo -e "\n================================\n"
        
        transfer_count=$((transfer_count + 1))
        last_transfer=$((faucet_count * FAUCET_INTERVAL))
        
        # Random th·ªùi gian cho l·∫ßn transfer ti·∫øp theo
        next_transfer_interval=$((TRANSFER_INTERVAL_MIN + RANDOM % (TRANSFER_INTERVAL_MAX - TRANSFER_INTERVAL_MIN + 1)))
        echo -e "${BLUE}[$(date '+%H:%M:%S')] üé≤ Transfer ti·∫øp theo sau: ${next_transfer_interval}s${NC}"
        echo -e "\n================================\n"
        
        # Check balance sau khi ho√†n t·∫•t c·∫£ 2 chi·ªÅu transfer
        check_balance $WALLET_NAME
        check_balance $WALLET_DEST
        
        echo -e "\n================================\n"
    fi
    
    # Ch·ªù tr∆∞·ªõc khi faucet l·∫ßn ti·∫øp theo
    echo -e "${BLUE}[$(date '+%H:%M:%S')] ‚è≥ Ch·ªù ${FAUCET_INTERVAL}s...${NC}"
    sleep $FAUCET_INTERVAL
done
